from database import create_stock_df, get_engine, create_df
import matplotlib.pyplot as plt
from mpl_finance import candlestick_ohlc
import matplotlib.dates as mdates
import pandas as pd
pd.core.common.is_list_like = pd.api.types.is_list_like


# Creates graph for given stock
def create_graph(ticker):
    df = create_stock_df(ticker)
    # Adding new data to the df and declaring what the data will be, for example rolling takes data for a number of days,
    # the window parameter, the min_period is the min that it calculates
    # df['100ma'] = df['Adj Close'].rolling(window=100, min_periods=0).mean()
    # df.dropna(inplace=True)

    # Calls method to create market data dataframe from sql query
    df = create_df(ticker)

    # Create the two
    df_ohlc = df['adj_close'].resample('10D').ohlc()
    df_volume = df['volume'].resample('10D').sum()

    df_ohlc.reset_index(inplace=True)
    df_ohlc['date'] = df_ohlc['date'].map(mdates.date2num)

    # Creates the two plots for the price chart, ax1 is the stock price data whilst ax2 is volume data
    ax1 = plt.subplot2grid((6, 1), (0, 0), rowspan=5, colspan=1)
    ax2 = plt.subplot2grid((6, 1), (5, 0), rowspan=1, colspan=1, sharex=ax1)
    ax1.xaxis_date()
    candlestick_ohlc(ax1, df_ohlc.values, width=2, colorup='g')
    ax2.fill_between(df_volume.index.map(mdates.date2num), df_volume.values, 0)

    plt.show()
